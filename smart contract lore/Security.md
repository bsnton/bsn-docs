
###### SMART CONTRACT LORE

# 安全
## 重放攻击保护
必须保护所有外部消息免受重放攻击。 否则，恶意方可以重新发送从区块链获得的外部消息并重复智能合约的交易。 例如，黑客可以重复令牌转移并将帐户余额归零。 对于内部消息，重放攻击的风险无关紧要，因为它们只能由其他合约在区块链内部生成。

## 实施选项

存在实现重放攻击保护的不同方法。 它们都不是灵丹妙药，但有几个指标可以用来比较和评估：

- gas消耗
- 存储费用
- 竞争条件
- 可用性
### 序列号

这是一个非常简单的保护选项。它意味着每个受保护的合约存储一个计数器(即32位整数)，该计数器最初被设置为零。只有在包含与当前契约计数器值相等的数字的情况下，契约才会接受外部消息。每接受一条新消息，契约计数器的值就增加1。

优点:

-   简单的合约执行;
-   低gas和storage fees;

缺点:

- 为了在链下获得正确的序列号，客户端必须在发送外部消息之前向区块链请求合约状态。如果状态很大，可能会导致网络流量开销;
- 当有多个合约所有者可以同时调用它时出现的竞争条件问题。一个所有者可以在这个计数器对下一个所有者可用之前增加合约计数器的价值;
- 较不敏感的问题，一个潜在的计数器溢出在未来。在这种情况下，TVM将抛出异常，导致所有者失去对合约的访问。

###  时间戳

时间戳
另一个简单的保护选项是为每条外部消息添加时间戳。 它可以是 unixtime 格式的 64-bit值。 合约必须存储最后接受的外部消息的时间戳。 当新的外部消息到来时，合约会验证消息时间戳。 它必须大于前一个消息时间戳并且小于`now + interval`。`interval`是必须的，因为`now`不代表当前时间，而是表示相关块的创建时间。 间隔可以等于块生成周期或更大。

优点:
- 非常简单的实现；
- 在发送外部消息之前无需请求帐户状态。messages.

缺点:
- 在序列号实现的情况下，竞争条件问题仍未解决；
- 客户端时间必须与区块链时间同步。
### 接受的消息集

1.  随机字典

此选项意味着每个外部消息都包含一个随机值，例如 32 位整数。 反过来，受保护的合约将先前使用的随机数存储在字典中，将消息随机数与其进行比较，如果检测到匹配则拒绝消息。

优点 :
-   在发送外部消息之前无需请求帐户状态；
-   没有竞争条件； 支持同时访问多方合约。 当多个客户端具有相同的随机数时，仍然可能发生冲突，但可以最大限度地减少这种可能性。

缺点:

- 字典写/读操作消耗大量gas。 注意未来gas费会增加；
- 存储字典的高存储费用。
1.  带有垃圾收集的消息字典

此选项意味着每条外部消息都包含一个“expire-at”整数，用于定义消息无效（即过期）的时间。 反过来，合约必须存储一个字典，其中包含所有最近接受且未过期的外部消息。 键是消息散列，值是相关的“expire-at”整数。

然后，合约拒绝其字典中已经存在的所有消息。 为了避免持续的数据增加，受保护的合约可以从其字典中删除“expire-at”值小于“now”的消息。

优点:

- 发送外部消息前无需请求账户状态；
- 没有竞争条件问题。

缺点:

- 与带有随机字典的上述选项相比，更难实现；
- 由于需要访问字典而导致的高gas费用；
- 存储费用高，但可以通过从字典中删除过期消息来减少这些费用；
- 垃圾收集还涉及一些天然气成本。

### 会话


在向合约发送请求之前，用户通过发送 create_session 外部消息来创建与合约的会话。 该消息包含一个新的会话 ID、它的过期时间和一个起始序列号。 合约存储会话字典。

创建会话后，用户将 session_id 和下一个会话序列号添加到每个外部消息中。 对于每个外部消息（不是 create_session），合约会检查：

- 消息会话 ID 存在于字典中
- 消息序列号等于存储的会话号，并且
- `now` 值小于 session 的 `expired-at` 值

如果所有检查都成功通过，合约会增加会话的存储序列号。 如果失败，消息将被拒绝。

此外，过期的会话需要一些垃圾收集。

优点:

- 发送外部消息前无需请求账户状态；
- 没有竞争条件问题；
- 没有碰撞。

缺点:

- 与上述所有选项相比，更难实施；
- gas费高；
- 仓储费高；
- 需要使用垃圾回收；
- 不适合简单的单用户合约。

## 结论

结论
在 TON Labs 中，我们选择了轻量级且简单的重放保护选项； 默认情况下，它将在编译器中实现，并基于`timestamp` 方法。 它应该适用于单用户合约以及没有严重竞争条件的合约。 鉴于 TON Labs SDK 能够在客户端自动插入时间戳，因此使用起来很容易。 此外，将有一个选项可以通过重载特殊的合约函数来重新定义默认保护方法。 这就是合约开发人员将能够实施他们认为合适的任何保护选项的方式。
